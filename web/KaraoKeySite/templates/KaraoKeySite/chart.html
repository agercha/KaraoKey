{% extends "KaraoKeySite/base.html" %}

{% block title %} KaraoKey {% endblock %}

{% block page-name %}
{% endblock %}

{% block js-src %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="../../static/KaraoKeySite/chartAJAX.js"></script>
{% endblock %}

{% block page-content %}
<div id="main">
  <div style="height:800px">
    <canvas id="myChart"></canvas>
  </div>
  
</div>

<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
<script type="text/javascript">
  const chartAreaBorder = {
    id: 'chartAreaBorder',
    beforeDraw(chart, args, options) {
      const {ctx, chartArea: {left, top, width, height}} = chart;
      ctx.save();
      ctx.strokeStyle = options.borderColor;
      ctx.lineWidth = options.borderWidth;
      ctx.setLineDash(options.borderDash || []);
      ctx.lineDashOffset = options.borderDashOffset;
      ctx.strokeRect(left, top, width, height);
      ctx.restore();
    }
  };

  var charty;

  function makeChart(xhr) {
    let vals = JSON.parse(xhr.responseText)
    const data = {
      labels: vals["labels"],
      datasets: [{
        data: vals["vals"],
        fill: false,
        tension: 0.1,
        stepped: true
      }]
    }
    var ctx = $("#myChart").get(0).getContext("2d");
    return new Chart(ctx, {
        type: 'line', 
        data: data,
        options: {
          events: [],
          animation: {
            duration: 0
          },
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            axis: 'x'
          },
          plugins: {
            title: {
              display: true,
              text: vals["lyrics"],
              font: {
                  size: 36
              }
            },
            chartAreaBorder: {
              borderColor: 'white',
              borderWidth: 5
            },
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              grid: {
                display: false
              },
              ticks: {
                display: false
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                display: false
              }
            }
          }
        },
        plugins: [chartAreaBorder]
      });
  }

  let xhr = new XMLHttpRequest()
  xhr.onreadystatechange = function() {
      if (this.readyState != 4) return
      charty = makeChart(xhr);
  }

  xhr.open("GET", "get-chart-json", true)
  xhr.send()


  function updateChart(xhr) {
    let vals = JSON.parse(xhr.responseText)
    const data = {
      labels: vals["labels"],
      datasets: [{
        data: vals["vals"],
        fill: false,
        tension: 0.1,
        stepped: true
      }]
    }
    charty.data = data;
    charty.options.plugins.title.text = vals["lyrics"];
    charty.update();
  }

  function myFunc() {
    let xhr = new XMLHttpRequest()
    xhr.onreadystatechange = function() {
      if (this.readyState != 4) return
      updateChart(xhr)
    }

    xhr.open("GET", "get-chart-json", true)
    xhr.send()

  }

  window.setInterval(myFunc, 3000);
</script>

{% endblock %}